!function(){var t,e=(function(){function t(t){this.id=t,this.lastTo=null,this.id="#"+this.id}return t.load=function(e,r){r||(r="kifuforjs_"+Math.random().toString(36).slice(2),document.write("<div id='"+r+"'></div>"));var n=new t(r);return n.prepareDOM(),$(document).ready(function(){$.ajax(e,{success:function(t){n.filename=e,n.initialize(o.parseKIF(t))},error:function(t,e){alert("棋譜読み込みに失敗しました: "+e)},beforeSend:function(t){t.overrideMimeType("text/html;charset=Shift_JIS")}})}),n},t.prototype.initialize=function(t){this.player=t,this.show()},t.prototype.prepareDOM=function(t){"undefined"==typeof t&&(t=!1);var e=this;$(function(){$(e.id).append('<table class="kifuforjs">			<tbody>				<tr>					<td>						<div class="inlineblock players">							<div class="mochi mochi1">								<div class="tebanname">☖</div>								<div class="mochimain"></div>							</div>							<div class="mochi">								<select class="kifulist" size="7"></select>							</div>						</div>					</td>					<td style="text-align:center">						<table class="ban">							<tbody>							</tbody>						</table>					</td>					<td>						<div class="inlineblock players">							<div class="mochi info">							</div>							<div class="mochi mochi0">								<div class="tebanname">☗</div>								<div class="mochimain"></div>							</div>						</div>					</td>				</tr>				<tr>					<td colspan=3 style="text-align:center">						<ul class="inline go" style="margin:0 auto;">							<li><button data-go="start">|&lt;</button></li>							<li><button data-go="-10">&lt;&lt;</button></li>							<li><button data-go="-1">&lt;</button></li>							<li>								<form action="?" style="display:inline">									<input type="text" name="tesuu" size="3" style="text-align:center">								</form>							</li>							<li><button data-go="1">&gt;</button></li>							<li><button data-go="10">&gt;&gt;</button></li>							<li><button data-go="end">&gt;|</button></li>						</ul>						<ul class="inline">							<li><button class="dl">保存</button>						</ul>						<textarea style="width:100%" rows=10 class="comment"></textarea>					</td>				</tr>			</tbody>		</table>');for(var r=0;1>=r;r++){var n=$("div.mochi.mochi"+r+" div.mochimain",e.id);["FU","KY","KE","GI","KI","KA","HI"].forEach(function(t){var o=$("<span class='mochigoma mochi_"+t+" mai0'></span>");o.data("value",0),o.append("<img src='"+e.getPieceImage(t,r)+"'>"),o.append("<span class='maisuu'></span>"),o.appendTo(n)})}e.kifulist=$("select.kifulist",e.id);var o=e;e.kifulist.change(function(){o.goto($(this).val()),o.refresh()}),$("ul.go",e.id).on("click","button",function(){o.go($(this).attr("data-go")),o.refresh()}),$("button.dl",e.id).on("click",function(){e.filename&&window.open(e.filename,"kifufile")}),$("ul.go form",e.id).submit(function(){return o.goto($("input",this).val()),o.refresh(),!1}),t&&e.show()})},t.prototype.show=function(){var e=this,r=$("table.ban tbody",this.id);r.children().remove();var n=$("<tr><th></th></tr>").appendTo(r);this.tds=[];for(var o=1;9>=o;o++)this.tds.push([]),$("<th>"+o+"</th>").prependTo(n);for(var u=1;9>=u;u++){var n=$("<tr></tr>").appendTo(r);$("<th>"+t.numToKanji(u)+"</th>").appendTo(n);for(var o=1;9>=o;o++)this.tds[o-1][u-1]=$("<td><img></td>").prependTo(n)}var i=$("select.kifulist",this.id);i.children().remove(),this.player.kifu.moves.forEach(function(r,n){$("<option value='"+n+"'>"+(e.player.getComments(n).length>0?"*":"&nbsp;")+t.pad(n.toString(),"&nbsp;",3)+" "+e.player.getReadableKifu(n)+"</option>").appendTo(i),o++});var s=this.player.kifu.header,a=$("<dl></dl>");for(var c in s)switch(c){case"先手":case"後手":this.setPlayer("先手"==c?0:1,s[c]);default:a.append($("<dt></dt>").text(c)),a.append($("<dd></dd>").text(s[c]))}var l=$("div.info",this.id);l.children().remove(),l.append(a),this.refresh()},t.prototype.refresh=function(){for(var t=1;9>=t;t++)for(var e=1;9>=e;e++)this.setPiece(t,e,this.player.getBoard(t,e));for(var r=0;1>=r;r++){var n=this.player.getHandsSummary(r);for(var o in n)this.setHand(r,o,n[o])}$("ul.go form input",this.id).val(this.player.tesuu.toString());try{$("select.kifulist option",this.id)[this.player.tesuu].selected=!0}catch(u){}$("textarea.comment",this.id).val(this.player.getComments().join("\n")),this.lastTo&&(this.tds[this.lastTo.x-1][this.lastTo.y-1].removeClass("lastto"),this.lastTo=null);var i=this.player.getMove();i&&i.to&&(this.lastTo=i.to,this.tds[this.lastTo.x-1][this.lastTo.y-1].addClass("lastto"))},t.prototype.setPiece=function(t,e,r){var n=$("img",this.tds[t-1][e-1]),o=this.getPieceImageByPiece(r);n.attr("src")!=o&&n.attr("src",o)},t.prototype.getHandDom=function(t,e){return $("div.mochi.mochi"+t+" div.mochimain span.mochigoma.mochi_"+e,this.id)},t.prototype.setHand=function(e,r,n){var o=this.getHandDom(e,r),u=o.data("value");u!=n&&(o.data("value",n),2>n?(o.removeClass("mai"+(1-n)),o.addClass("mai"+n)):($("span.maisuu",o).text(t.numToKanji(n)),o.removeClass("mai0 mai1")))},t.prototype.getPieceImageByPiece=function(t){return t?this.getPieceImage(t.kind,t.color):this.getPieceImage(null,null)},t.prototype.getPieceImage=function(e,r){return t.settings.ImageDirectoryPath+"/"+(e?r+e:"blank")+".png"},t.prototype.goto=function(t){isNaN(t)||this.player.goto(t)},t.prototype.go=function(t){if("start"==t)this.player.goto(0);else if("end"==t)this.player.goto(1/0);else{if(t=parseInt(t),isNaN(t))return;this.player.go(t)}},t.prototype.setPlayer=function(e,r){$("div.mochi.mochi"+e+" .tebanname",this.id).text(t.colorToMark(e)+r)},t.numToKanji=function(t){return"〇一二三四五六七八九"[t]},t.colorToMark=function(t){return 0==t?"☗":"☖"},t.pad=function(t,e,r){for(var n="",o=t.length;r>o;o++)n+=e;return n+t},t.settings={},t}(),function(){function t(){this.initialize()}return t.prototype.initialize=function(){this.board=[];for(var e=0;9>e;e++){this.board[e]=[];for(var r=0;9>r;r++){var o=t.initialBoard[r].slice(24-3*e,24-3*e+3);this.board[e][r]=" * "==o?null:new n(o)}}this.hands=[[],[]],this.turn=0,this.flagEditMode=!1},t.prototype.editMode=function(t){this.flagEditMode=t},t.prototype.move=function(t,e,r,n,o){"undefined"==typeof o&&(o=!1);var u=this.get(t,e);if(null==u)throw"no piece found at "+t+", "+e;if(this.checkTurn(u.color),!this.flagEditMode&&!this.getMovesFrom(t,e).some(function(t){return t.to.x==r&&t.to.y==n}))throw"cannot move from "+t+", "+e+" to "+r+", "+n;null!=this.get(r,n)&&this.capture(r,n),o&&u.promote(),this.set(r,n,u),this.set(t,e,null),this.nextTurn()},t.prototype.unmove=function(t,e,r,o,u,i){"undefined"==typeof u&&(u=!1);var s=this.get(r,o);if(null==s)throw"no piece found at "+r+", "+o;this.checkTurn(n.oppositeColor(s.color));var a;i&&(a=this.popFromHand(n.unpromote(i),s.color),a.inverse()),this.editMode(!0),this.move(r,o,t,e),u&&s.unpromote(),i&&(n.isPromoted(i)&&a.promote(),this.set(r,o,a)),this.editMode(!1),this.prevTurn()},t.prototype.drop=function(t,e,r,n){if("undefined"==typeof n&&(n=this.turn),this.checkTurn(n),null!=this.get(t,e))throw"there is a piece at "+t+", "+e;var o=this.popFromHand(r,n);this.set(t,e,o),this.nextTurn()},t.prototype.undrop=function(t,e){var r=this.get(t,e);if(this.checkTurn(n.oppositeColor(r.color)),null==r)throw"there is no piece at "+t+", "+e;this.pushToHand(r),this.set(t,e,null),this.prevTurn()},t.prototype.toCSAString=function(){for(var t=[],e=0;9>e;e++){for(var r="P"+(e+1),n=8;n>=0;n--){var o=this.board[n][e];r+=null==o?" * ":o.toCSAString()}t.push(r)}for(var u=0;2>u;u++){for(var r="P"+"+-"[u],i=0;i<this.hands[u].length;i++)r+="00"+this.hands[u][i].kind;t.push(r)}return t.push(0==this.turn?"+":"-"),t.join("\n")},t.prototype.getMovesFrom=function(t,e){var r=function(t,e,r){if(1>t||t>9||1>e||e>9)return!1;var n=this.get(t,e);return null==n||n.color!=r}.bind(this),o=this.get(t,e);if(null==o)return[];var u=n.getMoveDef(o.kind),i=[],s={x:t,y:e};if(u.just)for(var a=0;a<u.just.length;a++){var c=u.just[a];1==o.color&&(c[0]*=-1,c[1]*=-1);var l={x:s.x+c[0],y:s.y+c[1]};r(l.x,l.y,o.color)&&i.push({from:s,to:l})}if(u.fly)for(var a=0;a<u.fly.length;a++){var c=u.fly[a];1==o.color&&(c[0]*=-1,c[1]*=-1);for(var l={x:s.x+c[0],y:s.y+c[1]};r(l.x,l.y,o.color);)i.push({from:s,to:{x:l.x,y:l.y}}),l.x+=c[0],l.y+=c[1]}return i},t.prototype.getDropsBy=function(t){for(var e=[],r=[],n=1;9>=n;n++)for(var o=1;9>=o;o++)null==this.get(n,o)&&r.push({x:n,y:o});for(var u={},n=0;n<this.hands[t].length;n++){var i=this.hands[t][n].kind;if(!u[i]){u[i]=!0;for(var o=0;o<r.length;o++)e.push({to:r[o],color:t,kind:i})}}return e},t.prototype.getMovesTo=function(t,e,r,n){"undefined"==typeof n&&(n=this.turn);for(var o={x:t,y:e},u=[],i=1;9>=i;i++)for(var s=1;9>=s;s++){var a=this.get(i,s);if(a&&a.kind==r&&a.color==n){var c=this.getMovesFrom(i,s);c.some(function(r){return r.to.x==t&&r.to.y==e})&&u.push({from:{x:i,y:s},to:o})}}return u},t.prototype.get=function(t,e){return this.board[t-1][e-1]},t.prototype.getHandsSummary=function(t){for(var e={FU:0,KY:0,KE:0,GI:0,KI:0,KA:0,HI:0},r=0;r<this.hands[t].length;r++)e[this.hands[t][r].kind]++;return e},t.prototype.set=function(t,e,r){this.board[t-1][e-1]=r},t.prototype.capture=function(t,e){var r=this.get(t,e);this.set(t,e,null),r.unpromote(),r.inverse(),this.pushToHand(r)},t.prototype.pushToHand=function(t){this.hands[t.color].push(t)},t.prototype.popFromHand=function(t,e){for(var r=this.hands[e],n=0;n<r.length;n++)if(r[n].kind==t){var o=r[n];return r.splice(n,1),o}throw e+" has no "+t},t.prototype.nextTurn=function(){this.flagEditMode||(this.turn=0==this.turn?1:0)},t.prototype.prevTurn=function(){this.flagEditMode||this.nextTurn()},t.prototype.checkTurn=function(t){if(!this.flagEditMode&&t!=this.turn)throw"cannot move opposite piece"},t.initialBoard=["-KY-KE-GI-KI-OU-KI-GI-KE-KY"," * -HI *  *  *  *  * -KA * ","-FU-FU-FU-FU-FU-FU-FU-FU-FU"," *  *  *  *  *  *  *  *  * "," *  *  *  *  *  *  *  *  * "," *  *  *  *  *  *  *  *  * ","+FU+FU+FU+FU+FU+FU+FU+FU+FU"," * +KA *  *  *  *  * +HI * ","+KY+KE+GI+KI+OU+KI+GI+KE+KY"],t}());!function(t){t[t.Black=0]="Black",t[t.White=1]="White"}(t||(t={}));var r,n=function(){function t(t){this.color="+"==t.slice(0,1)?0:1,this.kind=t.slice(1)}return t.prototype.promote=function(){this.kind=t.promote(this.kind)},t.prototype.unpromote=function(){this.kind=t.unpromote(this.kind)},t.prototype.inverse=function(){this.color=0==this.color?1:0},t.prototype.toCSAString=function(){return(0==this.color?"+":"-")+this.kind},t.promote=function(t){return{FU:"TO",KY:"NY",KE:"NK",GI:"NG",KA:"UM",HI:"RY"}[t]||t},t.unpromote=function(t){return{TO:"FU",NY:"KY",NK:"KE",NG:"GI",KI:"KI",UM:"KA",RY:"HI",OU:"OU"}[t]||t},t.getMoveDef=function(t){switch(t){case"FU":return{just:[[0,-1]]};case"KY":return{fly:[[0,-1]]};case"KE":return{just:[[-1,-2],[1,-2]]};case"GI":return{just:[[-1,-1],[0,-1],[1,-1],[-1,1],[1,1]]};case"KI":case"TO":case"NY":case"NK":case"NG":return{just:[[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[0,1]]};case"KA":return{fly:[[-1,-1],[1,-1],[-1,1],[1,1]]};case"HI":return{fly:[[0,-1],[-1,0],[1,0],[0,1]]};case"OU":return{just:[[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]]};case"UM":return{fly:[[-1,-1],[1,-1],[-1,1],[1,1]],just:[[0,-1],[-1,0],[1,0],[0,1]]};case"RY":return{fly:[[0,-1],[-1,0],[1,0],[0,1]],just:[[-1,-1],[1,-1],[-1,1],[1,1]]}}},t.isPromoted=function(t){return["TO","NY","NK","NG","UM","RY"].indexOf(t)>=0},t.oppositeColor=function(t){return 0==t?1:0},t.prototype.isPromoted=function(){return t.isPromoted(this.kind)},t}(),o=function(){function t(t){this.shogi=new e,this.initialize(t)}return t.prototype.initialize=function(t){this.kifu=t,this.tesuu=0},t.parseKIF=function(e){if(!t.kifParser)throw"パーサが読み込まれていません";return console.log("parseKIF",e),new t(r.normalizeKIF(t.kifParser.parse(e)))},t.parseKI2=function(e){if(!t.ki2Parser)throw"パーサが読み込まれていません";return console.log("parseKI2",e),new t(r.normalizeKI2(t.ki2Parser.parse(e)))},t.parseCSA=function(e){if(!t.csaParser)throw"パーサが読み込まれていません";return console.log("parseCSA",e),new t(r.normalizeCSA(t.csaParser.parse(e)))},t.numToZen=function(t){return"０１２３４５６７８９"[t]},t.numToKan=function(t){return"〇一二三四五六七八九"[t]},t.kindToKan=function(t){return{FU:"歩",KY:"香",KE:"桂",GI:"銀",KI:"金",KA:"角",HI:"飛",OU:"玉",TO:"と",NY:"成香",NK:"成桂",NG:"成銀",UM:"馬",RY:"龍"}[t]},t.relativeToKan=function(t){return{L:"左",C:"直",R:"右",U:"上",M:"寄",D:"引",H:"打"}[t]},t.specialToKan=function(t){return{TORYO:"投了"}[t]},t.prototype.forward=function(){if(this.tesuu+1>=this.kifu.moves.length)return!1;this.tesuu++;var t=this.kifu.moves[this.tesuu].move;return t?(console.log("forward",this.tesuu,t),this.doMove(t),!0):!0},t.prototype.backward=function(){if(this.tesuu<=0)return!1;var t=this.kifu.moves[this.tesuu].move;return t?(console.log("backward",this.tesuu-1,t),this.undoMove(t),this.tesuu--,!0):(this.tesuu--,!0)},t.prototype.goto=function(t){var e=1e4;if(this.tesuu<t)for(;this.tesuu!=t&&this.forward()&&e-->0;);else for(;this.tesuu!=t&&this.backward()&&e-->0;);if(0==e)throw"tesuu overflows"},t.prototype.go=function(t){this.goto(this.tesuu+t)},t.prototype.getBoard=function(t,e){return this.shogi.get(t,e)},t.prototype.getHandsSummary=function(t){return this.shogi.getHandsSummary(t)},t.prototype.getComments=function(t){return"undefined"==typeof t&&(t=this.tesuu),this.kifu.moves[t].comments},t.prototype.getMove=function(t){return"undefined"==typeof t&&(t=this.tesuu),this.kifu.moves[t].move},t.prototype.getReadableKifu=function(e){if("undefined"==typeof e&&(e=this.tesuu),0==e)return"開始局面";if(this.kifu.moves[e].special)return t.specialToKan(this.kifu.moves[e].special);var r=this.kifu.moves[e].move,n=0==this.getMoveTurn(e)?"☗":"☖";return n+=r.same?"同　":t.numToZen(r.to.x)+t.numToKan(r.to.y),n+=t.kindToKan(r.piece),r.relative&&(n+=r.relative.split("").map(t.relativeToKan).join("")),null!=r.promote&&(n+=r.promote?"成":"不成"),n},t.prototype.getMoveTurn=function(t){return t%2==1?0:1},t.prototype.doMove=function(t){t.from?this.shogi.move(t.from.x,t.from.y,t.to.x,t.to.y,t.promote):this.shogi.drop(t.to.x,t.to.y,t.piece)},t.prototype.undoMove=function(t){t.from?this.shogi.unmove(t.from.x,t.from.y,t.to.x,t.to.y,t.promote,t.capture):this.shogi.undrop(t.to.x,t.to.y)},t}();!function(t){function r(t,e){return 0==e?t.y<=3:t.y>=7}function o(t){switch(t.type){case"normal":return t;case"kif":return u(t);default:throw"not supported"}}function u(t){for(var o=new e,u=0;u<t.moves.length;u++){var i=t.moves[u].move;if(i)if(console.log(u,i),i.from){i.same&&(i.to=t.moves[u-1].move.to);var s=o.get(i.to.x,i.to.y);s&&(i.capture=s.kind),i.promote||n.isPromoted(i.piece)||(r(i.to,o.turn)||r(i.from,o.turn))&&(i.promote=!1);var c=o.getMovesTo(i.to.x,i.to.y,i.piece).map(function(t){return a(o.turn,l(t.to,t.from))});if(c.length>=2){var h=a(o.turn,l(i.to,i.from));i.relative=function(){return 1==c.filter(function(t){return t.y==h.y}).length?f(h.y):1==c.filter(function(t){return t.x==h.x}).length?p("UM"!=i.piece&&"RY"!=i.piece||0!=h.x?h.x:0==c.filter(function(t){return t.x<0}).length?-1:1):p(h.x)+f(h.y)}()}try{o.move(i.from.x,i.from.y,i.to.x,i.to.y,i.promote)}catch(d){console.log(u,"手目で失敗しました",d)}}else o.getMovesTo(i.to.x,i.to.y,i.piece).length>0&&(i.relative="H"),o.drop(i.to.x,i.to.y,i.piece)}return t}function i(){throw"not implemented"}function s(){throw"not implemented"}function a(t,e){return 0==t?e:{x:-e.x,y:-e.y}}function c(t,e){return t==e?0:t>e?1:-1}function l(t,e){return{x:c(t.x,e.x),y:c(t.y,e.y)}}function f(t){return 0==t?"M":t>0?"D":"U"}function p(t){return 0==t?"C":t>0?"R":"L"}t.normalize=o,t.normalizeKIF=u,t.normalizeKI2=i,t.normalizeCSA=s}(r||(r={})),o.kifParser=function(){function t(t,e){function r(){this.constructor=t}r.prototype=e.prototype,t.prototype=new r}function e(t,e,r,n,o,u){this.message=t,this.expected=e,this.found=r,this.offset=n,this.line=o,this.column=u,this.name="SyntaxError"}function r(t){function r(e){function r(e,r,n){var o,u;for(o=r;n>o;o++)u=t.charAt(o),"\n"===u?(e.seenCR||e.line++,e.column=1,e.seenCR=!1):"\r"===u||"\u2028"===u||"\u2029"===u?(e.line++,e.column=1,e.seenCR=!0):(e.column++,e.seenCR=!1)}return hr!==e&&(hr>e&&(hr=0,dr={line:1,column:1,seenCR:!1}),r(dr,hr,e),hr=e),dr}function n(t){vr>fr||(fr>vr&&(vr=fr,mr=[]),mr.push(t))}function o(n,o,u){function i(t){var e=1;for(t.sort(function(t,e){return t.description<e.description?-1:t.description>e.description?1:0});e<t.length;)t[e-1]===t[e]?t.splice(e,1):e++}function s(t,e){function r(t){function e(t){return t.charCodeAt(0).toString(16).toUpperCase()}return t.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E\x0F]/g,function(t){return"\\x0"+e(t)}).replace(/[\x10-\x1F\x80-\xFF]/g,function(t){return"\\x"+e(t)}).replace(/[\u0180-\u0FFF]/g,function(t){return"\\u0"+e(t)}).replace(/[\u1080-\uFFFF]/g,function(t){return"\\u"+e(t)})}var n,o,u,i=new Array(t.length);for(u=0;u<t.length;u++)i[u]=t[u].description;return n=t.length>1?i.slice(0,-1).join(", ")+" or "+i[t.length-1]:i[0],o=e?'"'+r(e)+'"':"end of input","Expected "+n+" but "+o+" found."}var a=r(u),c=u<t.length?t.charAt(u):null;return null!==o&&i(o),new e(null!==n?n:s(o,c),o,c,u,a.line,a.column)}function u(){var t,e,r,n,o,u;return t=fr,e=i(),e!==P?(r=s(),r!==P?(n=c(),n===P&&(n=Y),n!==P?(o=l(),o!==P?(u=k(),u===P&&(u=Y),u!==P?(pr=t,e=H(r,o,u),t=e):(fr=t,t=S)):(fr=t,t=S)):(fr=t,t=S)):(fr=t,t=S)):(fr=t,t=S),t}function i(){var e,r,o,u;if(e=fr,35===t.charCodeAt(fr)?(r=O,fr++):(r=P,0===yr&&n(G)),r!==P){for(o=[],u=D();u!==P;)o.push(u),u=D();o!==P?(u=T(),u!==P?(r=[r,o,u],e=r):(fr=e,e=S)):(fr=e,e=S)}else fr=e,e=S;return e===P&&(e=z),e}function s(){var t,e,r;return t=fr,e=a(),e!==P?(r=s(),r!==P?(pr=t,e=Z(e,r),t=e):(fr=t,t=S)):(fr=t,t=S),t===P&&(t=fr,e=z,e!==P&&(pr=t,e=_()),t=e),t}function a(){var e,r,o,u,i;if(e=fr,r=[],L.test(t.charAt(fr))?(o=t.charAt(fr),fr++):(o=P,0===yr&&n(W)),o!==P)for(;o!==P;)r.push(o),L.test(t.charAt(fr))?(o=t.charAt(fr),fr++):(o=P,0===yr&&n(W));else r=S;if(r!==P)if(65306===t.charCodeAt(fr)?(o=J,fr++):(o=P,0===yr&&n(q)),o!==P){for(u=[],i=D();i!==P;)u.push(i),i=D();u!==P?(i=T(),i!==P?(pr=e,r=Q(r,u),e=r):(fr=e,e=S)):(fr=e,e=S)}else fr=e,e=S;else fr=e,e=S;return e}function c(){var e,r,o,u;return e=fr,t.substr(fr,10)===V?(r=V,fr+=10):(r=P,0===yr&&n(X)),r!==P?(t.substr(fr,13)===te?(o=te,fr+=13):(o=P,0===yr&&n(ee)),o===P&&(o=Y),o!==P?(u=T(),u!==P?(r=[r,o,u],e=r):(fr=e,e=S)):(fr=e,e=S)):(fr=e,e=S),e}function l(){var t,e,r,n;if(t=fr,e=f(),e!==P){for(r=[],n=p();n!==P;)r.push(n),n=p();r!==P?(pr=t,e=re(e,r),t=e):(fr=t,t=S)}else fr=t,t=S;return t}function f(){var t,e,r;for(t=fr,e=[],r=b();r!==P;)e.push(r),r=b();return e!==P?(r=h(),r===P&&(r=Y),r!==P?(pr=t,e=ne(e),t=e):(fr=t,t=S)):(fr=t,t=S),t}function p(){var t,e,r,n;if(t=fr,e=d(),e!==P){for(r=[],n=b();n!==P;)r.push(n),n=b();r!==P?(n=h(),n===P&&(n=Y),n!==P?(pr=t,e=oe(e,r),t=e):(fr=t,t=S)):(fr=t,t=S)}else fr=t,t=S;return t}function h(){var e,r,o,u;if(e=fr,38===t.charCodeAt(fr)?(r=ue,fr++):(r=P,0===yr&&n(ie)),r!==P){for(o=[],u=D();u!==P;)o.push(u),u=D();o!==P?(u=T(),u!==P?(r=[r,o,u],e=r):(fr=e,e=S)):(fr=e,e=S)}else fr=e,e=S;return e}function d(){var e,r,o,u,i,s,a,c;for(e=fr,r=[],32===t.charCodeAt(fr)?(o=se,fr++):(o=P,0===yr&&n(ae));o!==P;)r.push(o),32===t.charCodeAt(fr)?(o=se,fr++):(o=P,0===yr&&n(ae));if(r!==P)if(o=v(),o!==P){for(u=[],32===t.charCodeAt(fr)?(i=se,fr++):(i=P,0===yr&&n(ae));i!==P;)u.push(i),32===t.charCodeAt(fr)?(i=se,fr++):(i=P,0===yr&&n(ae));if(u!==P)if(i=fr,s=m(),s!==P?(a=C(),a!==P?(pr=i,s=ce(s,a),i=s):(fr=i,i=S)):(fr=i,i=S),i===P&&(t.substr(fr,2)===le?(i=le,fr+=2):(i=P,0===yr&&n(fe))),i!==P){for(s=[],32===t.charCodeAt(fr)?(a=se,fr++):(a=P,0===yr&&n(ae));a!==P;)s.push(a),32===t.charCodeAt(fr)?(a=se,fr++):(a=P,0===yr&&n(ae));s!==P?(a=x(),a===P&&(a=Y),a!==P?(c=T(),c!==P?(pr=e,r=pe(i,a),e=r):(fr=e,e=S)):(fr=e,e=S)):(fr=e,e=S)}else fr=e,e=S;else fr=e,e=S}else fr=e,e=S;else fr=e,e=S;return e}function v(){var e,r;if(e=[],he.test(t.charAt(fr))?(r=t.charAt(fr),fr++):(r=P,0===yr&&n(de)),r!==P)for(;r!==P;)e.push(r),he.test(t.charAt(fr))?(r=t.charAt(fr),fr++):(r=P,0===yr&&n(de));else e=S;return e}function m(){var e,r,o,u;return e=fr,r=y(),r!==P?(o=A(),o!==P?(25104===t.charCodeAt(fr)?(u=ve,fr++):(u=P,0===yr&&n(me)),u===P&&(u=Y),u!==P?(pr=e,r=ye(r,o,u),e=r):(fr=e,e=S)):(fr=e,e=S)):(fr=e,e=S),e}function y(){var e,r,o;return e=fr,r=F(),r!==P?(o=g(),o!==P?(pr=e,r=Fe(r,o),e=r):(fr=e,e=S)):(fr=e,e=S),e===P&&(e=fr,t.substr(fr,2)===ge?(r=ge,fr+=2):(r=P,0===yr&&n(Ae)),r!==P&&(pr=e,r=Ce()),e=r),e}function F(){var e,r;return e=fr,xe.test(t.charAt(fr))?(r=t.charAt(fr),fr++):(r=P,0===yr&&n(Ee)),r!==P&&(pr=e,r=Ke(r)),e=r}function g(){var e,r;return e=fr,be.test(t.charAt(fr))?(r=t.charAt(fr),fr++):(r=P,0===yr&&n(ke)),r!==P&&(pr=e,r=Te(r)),e=r}function A(){var e,r,o;return e=fr,25104===t.charCodeAt(fr)?(r=ve,fr++):(r=P,0===yr&&n(me)),r===P&&(r=Y),r!==P?(De.test(t.charAt(fr))?(o=t.charAt(fr),fr++):(o=P,0===yr&&n(Ie)),o!==P?(pr=e,r=we(r,o),e=r):(fr=e,e=S)):(fr=e,e=S),e}function C(){var e,r,o,u,i;return e=fr,25171===t.charCodeAt(fr)?(r=Be,fr++):(r=P,0===yr&&n(Ue)),r!==P&&(pr=e,r=Ce()),e=r,e===P&&(e=fr,40===t.charCodeAt(fr)?(r=Re,fr++):(r=P,0===yr&&n(Me)),r!==P?(je.test(t.charAt(fr))?(o=t.charAt(fr),fr++):(o=P,0===yr&&n(Pe)),o!==P?(je.test(t.charAt(fr))?(u=t.charAt(fr),fr++):(u=P,0===yr&&n(Pe)),u!==P?(41===t.charCodeAt(fr)?(i=$e,fr++):(i=P,0===yr&&n(Ne)),i!==P?(pr=e,r=Se(o,u),e=r):(fr=e,e=S)):(fr=e,e=S)):(fr=e,e=S)):(fr=e,e=S)),e}function x(){var e,r,o,u,i,s,a;if(e=fr,40===t.charCodeAt(fr)?(r=Re,fr++):(r=P,0===yr&&n(Me)),r!==P){for(o=[],32===t.charCodeAt(fr)?(u=se,fr++):(u=P,0===yr&&n(ae));u!==P;)o.push(u),32===t.charCodeAt(fr)?(u=se,fr++):(u=P,0===yr&&n(ae));o!==P?(u=K(),u!==P?(47===t.charCodeAt(fr)?(i=Ye,fr++):(i=P,0===yr&&n(He)),i!==P?(s=E(),s!==P?(41===t.charCodeAt(fr)?(a=$e,fr++):(a=P,0===yr&&n(Ne)),a!==P?(pr=e,r=Oe(u,s),e=r):(fr=e,e=S)):(fr=e,e=S)):(fr=e,e=S)):(fr=e,e=S)):(fr=e,e=S)}else fr=e,e=S;return e}function E(){var e,r,o,u,i,s,a;if(e=fr,r=[],he.test(t.charAt(fr))?(o=t.charAt(fr),fr++):(o=P,0===yr&&n(de)),o!==P)for(;o!==P;)r.push(o),he.test(t.charAt(fr))?(o=t.charAt(fr),fr++):(o=P,0===yr&&n(de));else r=S;if(r!==P)if(58===t.charCodeAt(fr)?(o=Ge,fr++):(o=P,0===yr&&n(ze)),o!==P){if(u=[],he.test(t.charAt(fr))?(i=t.charAt(fr),fr++):(i=P,0===yr&&n(de)),i!==P)for(;i!==P;)u.push(i),he.test(t.charAt(fr))?(i=t.charAt(fr),fr++):(i=P,0===yr&&n(de));else u=S;if(u!==P)if(58===t.charCodeAt(fr)?(i=Ge,fr++):(i=P,0===yr&&n(ze)),i!==P){if(s=[],he.test(t.charAt(fr))?(a=t.charAt(fr),fr++):(a=P,0===yr&&n(de)),a!==P)for(;a!==P;)s.push(a),he.test(t.charAt(fr))?(a=t.charAt(fr),fr++):(a=P,0===yr&&n(de));else s=S;s!==P?(pr=e,r=Ze(r,u,s),e=r):(fr=e,e=S)}else fr=e,e=S;else fr=e,e=S}else fr=e,e=S;else fr=e,e=S;return e}function K(){var e,r,o,u,i;if(e=fr,r=[],he.test(t.charAt(fr))?(o=t.charAt(fr),fr++):(o=P,0===yr&&n(de)),o!==P)for(;o!==P;)r.push(o),he.test(t.charAt(fr))?(o=t.charAt(fr),fr++):(o=P,0===yr&&n(de));else r=S;if(r!==P)if(58===t.charCodeAt(fr)?(o=Ge,fr++):(o=P,0===yr&&n(ze)),o!==P){if(u=[],he.test(t.charAt(fr))?(i=t.charAt(fr),fr++):(i=P,0===yr&&n(de)),i!==P)for(;i!==P;)u.push(i),he.test(t.charAt(fr))?(i=t.charAt(fr),fr++):(i=P,0===yr&&n(de));else u=S;u!==P?(pr=e,r=_e(r,u),e=r):(fr=e,e=S)}else fr=e,e=S;else fr=e,e=S;return e}function b(){var e,r,o,u;if(e=fr,42===t.charCodeAt(fr)?(r=Le,fr++):(r=P,0===yr&&n(We)),r!==P){for(o=[],u=D();u!==P;)o.push(u),u=D();o!==P?(u=T(),u!==P?(pr=e,r=Je(o),e=r):(fr=e,e=S)):(fr=e,e=S)}else fr=e,e=S;return e}function k(){var e,r,o,u,i,s,a;if(e=fr,t.substr(fr,2)===qe?(r=qe,fr+=2):(r=P,0===yr&&n(Qe)),r!==P){if(o=[],he.test(t.charAt(fr))?(u=t.charAt(fr),fr++):(u=P,0===yr&&n(de)),u!==P)for(;u!==P;)o.push(u),he.test(t.charAt(fr))?(u=t.charAt(fr),fr++):(u=P,0===yr&&n(de));else o=S;o!==P?(t.substr(fr,2)===Ve?(u=Ve,fr+=2):(u=P,0===yr&&n(Xe)),u!==P?(tr.test(t.charAt(fr))?(i=t.charAt(fr),fr++):(i=P,0===yr&&n(er)),i!==P?(t.substr(fr,4)===rr?(s=rr,fr+=4):(s=P,0===yr&&n(nr)),s!==P?(a=T(),a!==P?(pr=e,r=or(i),e=r):(fr=e,e=S)):(fr=e,e=S)):(fr=e,e=S)):(fr=e,e=S)):(fr=e,e=S)}else fr=e,e=S;return e}function T(){var e,r,o;return e=fr,13===t.charCodeAt(fr)?(r=ur,fr++):(r=P,0===yr&&n(ir)),r===P&&(r=Y),r!==P?(10===t.charCodeAt(fr)?(o=sr,fr++):(o=P,0===yr&&n(ar)),o!==P?(r=[r,o],e=r):(fr=e,e=S)):(fr=e,e=S),e}function D(){var e;return cr.test(t.charAt(fr))?(e=t.charAt(fr),fr++):(e=P,0===yr&&n(lr)),e}function I(t){return parseInt(t.join(""),10)}function w(t){return"０１２３４５６７８９".indexOf(t)}function B(t){return"〇一二三四五六七八九".indexOf(t)}function U(t){return"成"==t[0]?{"香":"NY","桂":"NK","銀":"NG"}[t[1]]:{"歩":"FU","香":"KY","桂":"KE","銀":"GI","金":"KI","角":"KA","飛":"HI","玉":"OU","と":"TO","馬":"UM","龍":"RY"}[t]}function R(t){return{"投了":"TORYO"}[t]}var M,j=arguments.length>1?arguments[1]:{},P={},$={kifu:u},N=u,S=P,Y=null,H=function(t,e,r){return{header:t,moves:e,result:r,type:"kif"}},O="#",G={type:"literal",value:"#",description:'"#"'},z="",Z=function(t,e){return e[t.k]=t.v,e},_=function(){return{}},L=/^[^\uFF1A\r\n]/,W={type:"class",value:"[^\\uFF1A\\r\\n]",description:"[^\\uFF1A\\r\\n]"},J="：",q={type:"literal",value:"：",description:'"\\uFF1A"'},Q=function(t,e){return{k:t.join(""),v:e.join("")}},V="手数----指手--",X={type:"literal",value:"手数----指手--",description:'"\\u624B\\u6570----\\u6307\\u624B--"'},te="-------消費時間--",ee={type:"literal",value:"-------消費時間--",description:'"-------\\u6D88\\u8CBB\\u6642\\u9593--"'},re=function(t,e){return e.unshift(t),e},ne=function(t){return{comments:t}},oe=function(t,e){var r={comments:e,time:t.time};return"object"==typeof t.move?r.move=t.move:r.special=R(t.move),r},ue="&",ie={type:"literal",value:"&",description:'"&"'},se=" ",ae={type:"literal",value:" ",description:'" "'},ce=function(t,e){var r={from:e,piece:t.piece};return t.to?r.to=t.to:r.same=!0,t.promote&&(r.promote=!0),r},le="投了",fe={type:"literal",value:"投了",description:'"\\u6295\\u4E86"'},pe=function(t,e){return{move:t,time:e}},he=/^[0-9]/,de={type:"class",value:"[0-9]",description:"[0-9]"},ve="成",me={type:"literal",value:"成",description:'"\\u6210"'},ye=function(t,e,r){return{to:t,piece:e,promote:!!r}},Fe=function(t,e){return{x:t,y:e}},ge="同　",Ae={type:"literal",value:"同　",description:'"\\u540C\\u3000"'},Ce=function(){return null},xe=/^[\uFF11\uFF12\uFF13\uFF14\uFF15\uFF16\uFF17\uFF18\uFF19]/,Ee={type:"class",value:"[\\uFF11\\uFF12\\uFF13\\uFF14\\uFF15\\uFF16\\uFF17\\uFF18\\uFF19]",description:"[\\uFF11\\uFF12\\uFF13\\uFF14\\uFF15\\uFF16\\uFF17\\uFF18\\uFF19]"},Ke=function(t){return w(t)},be=/^[\u4E00\u4E8C\u4E09\u56DB\u4E94\u516D\u4E03\u516B\u4E5D]/,ke={type:"class",value:"[\\u4E00\\u4E8C\\u4E09\\u56DB\\u4E94\\u516D\\u4E03\\u516B\\u4E5D]",description:"[\\u4E00\\u4E8C\\u4E09\\u56DB\\u4E94\\u516D\\u4E03\\u516B\\u4E5D]"},Te=function(t){return B(t)},De=/^[\u6B69\u9999\u6842\u9280\u91D1\u89D2\u98DB\u7389\u3068\u99AC\u9F8D]/,Ie={type:"class",value:"[\\u6B69\\u9999\\u6842\\u9280\\u91D1\\u89D2\\u98DB\\u7389\\u3068\\u99AC\\u9F8D]",description:"[\\u6B69\\u9999\\u6842\\u9280\\u91D1\\u89D2\\u98DB\\u7389\\u3068\\u99AC\\u9F8D]"},we=function(t,e){return U((t||"")+e)},Be="打",Ue={type:"literal",value:"打",description:'"\\u6253"'},Re="(",Me={type:"literal",value:"(",description:'"("'},je=/^[1-9]/,Pe={type:"class",value:"[1-9]",description:"[1-9]"},$e=")",Ne={type:"literal",value:")",description:'")"'},Se=function(t,e){return{x:parseInt(t),y:parseInt(e)}},Ye="/",He={type:"literal",value:"/",description:'"/"'},Oe=function(t,e){return{now:t,total:e}},Ge=":",ze={type:"literal",value:":",description:'":"'},Ze=function(t,e,r){return{h:I(t),m:I(e),s:I(r)}},_e=function(t,e){return{m:I(t),s:I(e)}},Le="*",We={type:"literal",value:"*",description:'"*"'},Je=function(t){return t.join("")},qe="まで",Qe={type:"literal",value:"まで",description:'"\\u307E\\u3067"'},Ve="手で",Xe={type:"literal",value:"手で",description:'"\\u624B\\u3067"'},tr=/^[\u5148\u5F8C]/,er={type:"class",value:"[\\u5148\\u5F8C]",description:"[\\u5148\\u5F8C]"},rr="手の勝ち",nr={type:"literal",value:"手の勝ち",description:'"\\u624B\\u306E\\u52DD\\u3061"'},or=function(t){return t[0]},ur="\r",ir={type:"literal",value:"\r",description:'"\\r"'},sr="\n",ar={type:"literal",value:"\n",description:'"\\n"'},cr=/^[^\r\n]/,lr={type:"class",value:"[^\\r\\n]",description:"[^\\r\\n]"},fr=0,pr=0,hr=0,dr={line:1,column:1,seenCR:!1},vr=0,mr=[],yr=0;if("startRule"in j){if(!(j.startRule in $))throw new Error("Can't start parsing from rule \""+j.startRule+'".');N=$[j.startRule]}if(M=N(),M!==P&&fr===t.length)return M;throw M!==P&&fr<t.length&&n({type:"end",description:"end of input"}),o(null,mr,vr)}return t(e,Error),{SyntaxError:e,parse:r}}(),o.ki2Parser=function(){function t(t,e){function r(){this.constructor=t}r.prototype=e.prototype,t.prototype=new r}function e(t,e,r,n,o,u){this.message=t,this.expected=e,this.found=r,this.offset=n,this.line=o,this.column=u,this.name="SyntaxError"}function r(t){function r(e){function r(e,r,n){var o,u;for(o=r;n>o;o++)u=t.charAt(o),"\n"===u?(e.seenCR||e.line++,e.column=1,e.seenCR=!1):"\r"===u||"\u2028"===u||"\u2029"===u?(e.line++,e.column=1,e.seenCR=!0):(e.column++,e.seenCR=!1)}return Le!==e&&(Le>e&&(Le=0,We={line:1,column:1,seenCR:!1}),r(We,Le,e),Le=e),We}function n(t){Je>Ze||(Ze>Je&&(Je=Ze,qe=[]),qe.push(t))}function o(n,o,u){function i(t){var e=1;for(t.sort(function(t,e){return t.description<e.description?-1:t.description>e.description?1:0});e<t.length;)t[e-1]===t[e]?t.splice(e,1):e++}function s(t,e){function r(t){function e(t){return t.charCodeAt(0).toString(16).toUpperCase()}return t.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E\x0F]/g,function(t){return"\\x0"+e(t)}).replace(/[\x10-\x1F\x80-\xFF]/g,function(t){return"\\x"+e(t)}).replace(/[\u0180-\u0FFF]/g,function(t){return"\\u0"+e(t)}).replace(/[\u1080-\uFFFF]/g,function(t){return"\\u"+e(t)})}var n,o,u,i=new Array(t.length);for(u=0;u<t.length;u++)i[u]=t[u].description;return n=t.length>1?i.slice(0,-1).join(", ")+" or "+i[t.length-1]:i[0],o=e?'"'+r(e)+'"':"end of input","Expected "+n+" but "+o+" found."}var a=r(u),c=u<t.length?t.charAt(u):null;return null!==o&&i(o),new e(null!==n?n:s(o,c),o,c,u,a.line,a.column)}function u(){var t,e,r,n;return t=Ze,e=i(),e!==I?(r=a(),r!==I?(n=C(),n===I&&(n=R),n!==I?(_e=t,e=M(e,r,n),t=e):(Ze=t,t=U)):(Ze=t,t=U)):(Ze=t,t=U),t}function i(){var t,e,r;return t=Ze,e=s(),e!==I?(r=i(),r!==I?(_e=t,e=j(e,r),t=e):(Ze=t,t=U)):(Ze=t,t=U),t===I&&(t=Ze,e=P,e!==I&&(_e=t,e=$()),t=e),t}function s(){var e,r,o,u,i,s;if(e=Ze,r=[],N.test(t.charAt(Ze))?(o=t.charAt(Ze),Ze++):(o=I,0===Qe&&n(S)),o!==I)for(;o!==I;)r.push(o),N.test(t.charAt(Ze))?(o=t.charAt(Ze),Ze++):(o=I,0===Qe&&n(S));else r=U;if(r!==I)if(65306===t.charCodeAt(Ze)?(o=Y,Ze++):(o=I,0===Qe&&n(H)),o!==I){for(u=[],i=E();i!==I;)u.push(i),i=E();if(u!==I){if(i=[],s=x(),s!==I)for(;s!==I;)i.push(s),s=x();else i=U;i!==I?(_e=e,r=O(r,u),e=r):(Ze=e,e=U)}else Ze=e,e=U}else Ze=e,e=U;else Ze=e,e=U;return e}function a(){var t,e,r,n;if(t=Ze,e=c(),e!==I){for(r=[],n=l();n!==I;)r.push(n),n=l();r!==I?(_e=t,e=G(e,r),t=e):(Ze=t,t=U)}else Ze=t,t=U;return t}function c(){var t,e,r;for(t=Ze,e=[],r=A();r!==I;)e.push(r),r=A();return e!==I?(r=f(),r===I&&(r=R),r!==I?(_e=t,e=z(e),t=e):(Ze=t,t=U)):(Ze=t,t=U),t}function l(){var e,r,o,u,i,s;if(e=Ze,r=p(),r!==I){for(o=[],u=A();u!==I;)o.push(u),u=A();if(o!==I)if(u=f(),u===I&&(u=R),u!==I){for(i=[],s=x(),s===I&&(32===t.charCodeAt(Ze)?(s=Z,Ze++):(s=I,0===Qe&&n(_)));s!==I;)i.push(s),s=x(),s===I&&(32===t.charCodeAt(Ze)?(s=Z,Ze++):(s=I,0===Qe&&n(_)));i!==I?(_e=e,r=L(r,o),e=r):(Ze=e,e=U)}else Ze=e,e=U;else Ze=e,e=U}else Ze=e,e=U;return e}function f(){var e,r,o,u;if(e=Ze,38===t.charCodeAt(Ze)?(r=W,Ze++):(r=I,0===Qe&&n(J)),r!==I){for(o=[],u=E();u!==I;)o.push(u),u=E();o!==I?(u=x(),u!==I?(r=[r,o,u],e=r):(Ze=e,e=U)):(Ze=e,e=U)}else Ze=e,e=U;return e}function p(){var e,r,o,u,i;if(e=Ze,q.test(t.charAt(Ze))?(r=t.charAt(Ze),Ze++):(r=I,0===Qe&&n(Q)),r!==I)if(o=h(),o!==I){for(u=[],i=x(),i===I&&(32===t.charCodeAt(Ze)?(i=Z,Ze++):(i=I,0===Qe&&n(_)));i!==I;)u.push(i),i=x(),i===I&&(32===t.charCodeAt(Ze)?(i=Z,Ze++):(i=I,0===Qe&&n(_)));u!==I?(_e=e,r=V(o),e=r):(Ze=e,e=U)}else Ze=e,e=U;else Ze=e,e=U;return e}function h(){var e,r,o,u,i,s,a;
return e=Ze,r=d(),r!==I?(o=v(),o!==I?(u=m(),u===I&&(u=R),u!==I?(i=y(),i===I&&(i=R),i!==I?(25104===t.charCodeAt(Ze)?(s=X,Ze++):(s=I,0===Qe&&n(te)),s===I&&(t.substr(Ze,2)===ee?(s=ee,Ze+=2):(s=I,0===Qe&&n(re))),s===I&&(s=R),s!==I?(25171===t.charCodeAt(Ze)?(a=ne,Ze++):(a=I,0===Qe&&n(oe)),a===I&&(a=R),a!==I?(_e=e,r=ue(r,o,u,i,s,a),e=r):(Ze=e,e=U)):(Ze=e,e=U)):(Ze=e,e=U)):(Ze=e,e=U)):(Ze=e,e=U)):(Ze=e,e=U),e}function d(){var e,r,o;return e=Ze,r=F(),r!==I?(o=g(),o!==I?(_e=e,r=ie(r,o),e=r):(Ze=e,e=U)):(Ze=e,e=U),e===I&&(e=Ze,21516===t.charCodeAt(Ze)?(r=se,Ze++):(r=I,0===Qe&&n(ae)),r!==I?(12288===t.charCodeAt(Ze)?(o=ce,Ze++):(o=I,0===Qe&&n(le)),o===I&&(o=R),o!==I?(_e=e,r=fe(),e=r):(Ze=e,e=U)):(Ze=e,e=U)),e}function v(){var e,r,o;return e=Ze,25104===t.charCodeAt(Ze)?(r=X,Ze++):(r=I,0===Qe&&n(te)),r===I&&(r=R),r!==I?(pe.test(t.charAt(Ze))?(o=t.charAt(Ze),Ze++):(o=I,0===Qe&&n(he)),o!==I?(_e=e,r=de(r,o),e=r):(Ze=e,e=U)):(Ze=e,e=U),e}function m(){var e;return ve.test(t.charAt(Ze))?(e=t.charAt(Ze),Ze++):(e=I,0===Qe&&n(me)),e}function y(){var e;return ye.test(t.charAt(Ze))?(e=t.charAt(Ze),Ze++):(e=I,0===Qe&&n(Fe)),e}function F(){var e,r;return e=Ze,ge.test(t.charAt(Ze))?(r=t.charAt(Ze),Ze++):(r=I,0===Qe&&n(Ae)),r!==I&&(_e=e,r=Ce(r)),e=r}function g(){var e,r;return e=Ze,xe.test(t.charAt(Ze))?(r=t.charAt(Ze),Ze++):(r=I,0===Qe&&n(Ee)),r!==I&&(_e=e,r=Ke(r)),e=r}function A(){var e,r,o,u;if(e=Ze,42===t.charCodeAt(Ze)?(r=be,Ze++):(r=I,0===Qe&&n(ke)),r!==I){for(o=[],u=E();u!==I;)o.push(u),u=E();o!==I?(u=x(),u!==I?(_e=e,r=Te(o),e=r):(Ze=e,e=U)):(Ze=e,e=U)}else Ze=e,e=U;return e}function C(){var e,r,o,u,i,s,a;if(e=Ze,t.substr(Ze,2)===De?(r=De,Ze+=2):(r=I,0===Qe&&n(Ie)),r!==I){if(o=[],we.test(t.charAt(Ze))?(u=t.charAt(Ze),Ze++):(u=I,0===Qe&&n(Be)),u!==I)for(;u!==I;)o.push(u),we.test(t.charAt(Ze))?(u=t.charAt(Ze),Ze++):(u=I,0===Qe&&n(Be));else o=U;o!==I?(t.substr(Ze,2)===Ue?(u=Ue,Ze+=2):(u=I,0===Qe&&n(Re)),u!==I?(Me.test(t.charAt(Ze))?(i=t.charAt(Ze),Ze++):(i=I,0===Qe&&n(je)),i!==I?(t.substr(Ze,4)===Pe?(s=Pe,Ze+=4):(s=I,0===Qe&&n($e)),s!==I?(a=x(),a===I&&(a=R),a!==I?(_e=e,r=Ne(i),e=r):(Ze=e,e=U)):(Ze=e,e=U)):(Ze=e,e=U)):(Ze=e,e=U)):(Ze=e,e=U)}else Ze=e,e=U;return e}function x(){var e,r,o;return e=Ze,13===t.charCodeAt(Ze)?(r=Se,Ze++):(r=I,0===Qe&&n(Ye)),r===I&&(r=R),r!==I?(10===t.charCodeAt(Ze)?(o=He,Ze++):(o=I,0===Qe&&n(Oe)),o!==I?(r=[r,o],e=r):(Ze=e,e=U)):(Ze=e,e=U),e}function E(){var e;return Ge.test(t.charAt(Ze))?(e=t.charAt(Ze),Ze++):(e=I,0===Qe&&n(ze)),e}function K(t){return"０１２３４５６７８９".indexOf(t)}function b(t){return"〇一二三四五六七八九".indexOf(t)}function k(t){return"成"==t[0]?{"香":"NY","桂":"NK","銀":"NG"}[t[1]]:{"歩":"FU","香":"KY","桂":"KE","銀":"GI","金":"KI","角":"KA","飛":"HI","玉":"OU","と":"TO","馬":"UM","龍":"RY"}[t]}var T,D=arguments.length>1?arguments[1]:{},I={},w={kifu:u},B=u,U=I,R=null,M=function(t,e,r){return{header:t,moves:e,result:r,type:"ki2"}},j=function(t,e){return e[t.k]=t.v,e},P="",$=function(){return{}},N=/^[^\uFF1A\r\n]/,S={type:"class",value:"[^\\uFF1A\\r\\n]",description:"[^\\uFF1A\\r\\n]"},Y="：",H={type:"literal",value:"：",description:'"\\uFF1A"'},O=function(t,e){return{k:t.join(""),v:e.join("")}},G=function(t,e){return e.unshift(t),e},z=function(t){return{comments:t}},Z=" ",_={type:"literal",value:" ",description:'" "'},L=function(t,e){return{comments:e,move:t}},W="&",J={type:"literal",value:"&",description:'"&"'},q=/^[\u25B2\u25B3]/,Q={type:"class",value:"[\\u25B2\\u25B3]",description:"[\\u25B2\\u25B3]"},V=function(t){return t},X="成",te={type:"literal",value:"成",description:'"\\u6210"'},ee="不成",re={type:"literal",value:"不成",description:'"\\u4E0D\\u6210"'},ne="打",oe={type:"literal",value:"打",description:'"\\u6253"'},ue=function(t,e,r,n,o,u){var i={to:t,piece:e};return o&&(i.promote="成"==o),r&&(i.soutai=r),n&&(i.dousa=n),u&&(i.da=!!u),i},ie=function(t,e){return{x:t,y:e}},se="同",ae={type:"literal",value:"同",description:'"\\u540C"'},ce="　",le={type:"literal",value:"　",description:'"\\u3000"'},fe=function(){return{same:!0}},pe=/^[\u6B69\u9999\u6842\u9280\u91D1\u89D2\u98DB\u7389\u3068\u99AC\u9F8D]/,he={type:"class",value:"[\\u6B69\\u9999\\u6842\\u9280\\u91D1\\u89D2\\u98DB\\u7389\\u3068\\u99AC\\u9F8D]",description:"[\\u6B69\\u9999\\u6842\\u9280\\u91D1\\u89D2\\u98DB\\u7389\\u3068\\u99AC\\u9F8D]"},de=function(t,e){return k((t||"")+e)},ve=/^[\u5DE6\u76F4\u53F3]/,me={type:"class",value:"[\\u5DE6\\u76F4\\u53F3]",description:"[\\u5DE6\\u76F4\\u53F3]"},ye=/^[\u4E0A\u5BC4\u5F15]/,Fe={type:"class",value:"[\\u4E0A\\u5BC4\\u5F15]",description:"[\\u4E0A\\u5BC4\\u5F15]"},ge=/^[\uFF11\uFF12\uFF13\uFF14\uFF15\uFF16\uFF17\uFF18\uFF19]/,Ae={type:"class",value:"[\\uFF11\\uFF12\\uFF13\\uFF14\\uFF15\\uFF16\\uFF17\\uFF18\\uFF19]",description:"[\\uFF11\\uFF12\\uFF13\\uFF14\\uFF15\\uFF16\\uFF17\\uFF18\\uFF19]"},Ce=function(t){return K(t)},xe=/^[\u4E00\u4E8C\u4E09\u56DB\u4E94\u516D\u4E03\u516B\u4E5D]/,Ee={type:"class",value:"[\\u4E00\\u4E8C\\u4E09\\u56DB\\u4E94\\u516D\\u4E03\\u516B\\u4E5D]",description:"[\\u4E00\\u4E8C\\u4E09\\u56DB\\u4E94\\u516D\\u4E03\\u516B\\u4E5D]"},Ke=function(t){return b(t)},be="*",ke={type:"literal",value:"*",description:'"*"'},Te=function(t){return t.join("")},De="まで",Ie={type:"literal",value:"まで",description:'"\\u307E\\u3067"'},we=/^[0-9]/,Be={type:"class",value:"[0-9]",description:"[0-9]"},Ue="手で",Re={type:"literal",value:"手で",description:'"\\u624B\\u3067"'},Me=/^[\u5148\u5F8C]/,je={type:"class",value:"[\\u5148\\u5F8C]",description:"[\\u5148\\u5F8C]"},Pe="手の勝ち",$e={type:"literal",value:"手の勝ち",description:'"\\u624B\\u306E\\u52DD\\u3061"'},Ne=function(t){return t[0]},Se="\r",Ye={type:"literal",value:"\r",description:'"\\r"'},He="\n",Oe={type:"literal",value:"\n",description:'"\\n"'},Ge=/^[^\r\n]/,ze={type:"class",value:"[^\\r\\n]",description:"[^\\r\\n]"},Ze=0,_e=0,Le=0,We={line:1,column:1,seenCR:!1},Je=0,qe=[],Qe=0;if("startRule"in D){if(!(D.startRule in w))throw new Error("Can't start parsing from rule \""+D.startRule+'".');B=w[D.startRule]}if(T=B(),T!==I&&Ze===t.length)return T;throw T!==I&&Ze<t.length&&n({type:"end",description:"end of input"}),o(null,qe,Je)}return t(e,Error),{SyntaxError:e,parse:r}}(),o.csaParser=function(){function t(t,e){function r(){this.constructor=t}r.prototype=e.prototype,t.prototype=new r}function e(t,e,r,n,o,u){this.message=t,this.expected=e,this.found=r,this.offset=n,this.line=o,this.column=u,this.name="SyntaxError"}function r(t){function r(e){function r(e,r,n){var o,u;for(o=r;n>o;o++)u=t.charAt(o),"\n"===u?(e.seenCR||e.line++,e.column=1,e.seenCR=!1):"\r"===u||"\u2028"===u||"\u2029"===u?(e.line++,e.column=1,e.seenCR=!0):(e.column++,e.seenCR=!1)}return Pe!==e&&(Pe>e&&(Pe=0,$e={line:1,column:1,seenCR:!1}),r($e,Pe,e),Pe=e),$e}function n(t){Ne>Me||(Me>Ne&&(Ne=Me,Se=[]),Se.push(t))}function o(n,o,u){function i(t){var e=1;for(t.sort(function(t,e){return t.description<e.description?-1:t.description>e.description?1:0});e<t.length;)t[e-1]===t[e]?t.splice(e,1):e++}function s(t,e){function r(t){function e(t){return t.charCodeAt(0).toString(16).toUpperCase()}return t.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E\x0F]/g,function(t){return"\\x0"+e(t)}).replace(/[\x10-\x1F\x80-\xFF]/g,function(t){return"\\x"+e(t)}).replace(/[\u0180-\u0FFF]/g,function(t){return"\\u0"+e(t)}).replace(/[\u1080-\uFFFF]/g,function(t){return"\\u"+e(t)})}var n,o,u,i=new Array(t.length);for(u=0;u<t.length;u++)i[u]=t[u].description;return n=t.length>1?i.slice(0,-1).join(", ")+" or "+i[t.length-1]:i[0],o=e?'"'+r(e)+'"':"end of input","Expected "+n+" but "+o+" found."}var a=r(u),c=u<t.length?t.charAt(u):null;return null!==o&&i(o),new e(null!==n?n:s(o,c),o,c,u,a.line,a.column)}function u(){var t,e,r,n;return t=Me,e=i(),e===w&&(e=M),e!==w?(r=s(),r===w&&(r=M),r!==w?(n=d(),n!==w?(je=t,e=j(e,r,n),t=e):(Me=t,t=R)):(Me=t,t=R)):(Me=t,t=R),t}function i(){var e,r,o,u,i,s,a,c;for(e=Me,r=[],o=A();o!==w;)r.push(o),o=A();if(r!==w){if(o=Me,t.substr(Me,2)===P?(u=P,Me+=2):(u=w,0===Ye&&n($)),u!==w){for(i=[],s=k();s!==w;)i.push(s),s=k();i!==w?(s=b(),s!==w?(je=o,u=N(i),o=u):(Me=o,o=R)):(Me=o,o=R)}else Me=o,o=R;if(o===w&&(o=M),o!==w){for(u=[],i=A();i!==w;)u.push(i),i=A();if(u!==w){if(i=Me,t.substr(Me,2)===S?(s=S,Me+=2):(s=w,0===Ye&&n(Y)),s!==w){for(a=[],c=k();c!==w;)a.push(c),c=k();a!==w?(c=b(),c!==w?(je=i,s=H(a),i=s):(Me=i,i=R)):(Me=i,i=R)}else Me=i,i=R;i===w&&(i=M),i!==w?(je=e,r=O(o,i),e=r):(Me=e,e=R)}else Me=e,e=R}else Me=e,e=R}else Me=e,e=R;return e}function s(){var t,e,r,n,o,u;for(t=Me,e=[],r=A();r!==w;)e.push(r),r=A();if(e!==w)if(r=a(),r===w&&(r=c(),r===w&&(r=p())),r!==w){for(n=[],o=A();o!==w;)n.push(o),o=A();n!==w?(o=g(),o!==w?(u=b(),u!==w?(je=t,e=G(r,o),t=e):(Me=t,t=R)):(Me=t,t=R)):(Me=t,t=R)}else Me=t,t=R;else Me=t,t=R;return t}function a(){var e,r,o,u;if(e=Me,t.substr(Me,2)===z?(r=z,Me+=2):(r=w,0===Ye&&n(Z)),r!==w){for(o=[],u=K();u!==w;)o.push(u),u=K();o!==w?(r=[r,o],e=r):(Me=e,e=R)}else Me=e,e=R;return e}function c(){var t,e;if(t=[],e=l(),e!==w)for(;e!==w;)t.push(e),e=l();else t=R;return t}function l(){var e,r,o,u,i;if(e=Me,80===t.charCodeAt(Me)?(r=_,Me++):(r=w,0===Ye&&n(L)),r!==w)if(W.test(t.charAt(Me))?(o=t.charAt(Me),Me++):(o=w,0===Ye&&n(J)),o!==w){if(u=[],i=f(),i!==w)for(;i!==w;)u.push(i),i=f();else u=R;u!==w?(i=b(),i!==w?(je=e,r=q(u),e=r):(Me=e,e=R)):(Me=e,e=R)}else Me=e,e=R;else Me=e,e=R;return e}function f(){var e,r,o;return e=Me,r=g(),r!==w?(o=E(),o!==w?(r=[r,o],e=r):(Me=e,e=R)):(Me=e,e=R),e===w&&(e=Me,t.substr(Me,3)===Q?(r=Q,Me+=3):(r=w,0===Ye&&n(V)),r!==w&&(je=e,r=X()),e=r),e}function p(){var t,e;for(t=[],e=h();e!==w;)t.push(e),e=h();return t}function h(){var e,r,o,u,i;if(e=Me,80===t.charCodeAt(Me)?(r=_,Me++):(r=w,0===Ye&&n(L)),r!==w)if(o=g(),o!==w){if(u=[],i=K(),i!==w)for(;i!==w;)u.push(i),i=K();else u=R;u!==w?(i=b(),i!==w?(r=[r,o,u,i],e=r):(Me=e,e=R)):(Me=e,e=R)}else Me=e,e=R;else Me=e,e=R;return e}function d(){var t,e,r,n;if(t=Me,e=v(),e!==w){for(r=[],n=m();n!==w;)r.push(n),n=m();r!==w?(je=t,e=te(e,r),t=e):(Me=t,t=R)}else Me=t,t=R;return t}function v(){var t,e,r;for(t=Me,e=[],r=A();r!==w;)e.push(r),r=A();return e!==w&&(je=t,e=ee(e)),t=e}function m(){var t,e,r,n;for(t=Me,e=[],r=A();r!==w;)e.push(r),r=A();return e!==w?(r=y(),r===w&&(r=F()),r!==w?(n=C(),n===w&&(n=M),n!==w?(je=t,e=re(e,r,n),t=e):(Me=t,t=R)):(Me=t,t=R)):(Me=t,t=R),t}function y(){var t,e,r,n,o,u;return t=Me,e=g(),e!==w?(r=x(),r!==w?(n=x(),n!==w?(o=E(),o!==w?(u=b(),u!==w?(je=t,e=ne(r,n,o),t=e):(Me=t,t=R)):(Me=t,t=R)):(Me=t,t=R)):(Me=t,t=R)):(Me=t,t=R),t}function F(){var e,r,o,u;if(e=Me,37===t.charCodeAt(Me)?(r=oe,Me++):(r=w,0===Ye&&n(ue)),r!==w){if(o=[],ie.test(t.charAt(Me))?(u=t.charAt(Me),Me++):(u=w,0===Ye&&n(se)),u!==w)for(;u!==w;)o.push(u),ie.test(t.charAt(Me))?(u=t.charAt(Me),Me++):(u=w,0===Ye&&n(se));else o=R;o!==w?(u=b(),u!==w?(je=e,r=ae(o),e=r):(Me=e,e=R)):(Me=e,e=R)}else Me=e,e=R;return e}function g(){var e;return 43===t.charCodeAt(Me)?(e=ce,Me++):(e=w,0===Ye&&n(le)),e===w&&(45===t.charCodeAt(Me)?(e=fe,Me++):(e=w,0===Ye&&n(pe))),e}function A(){var e,r,o,u;if(e=Me,39===t.charCodeAt(Me)?(r=he,Me++):(r=w,0===Ye&&n(de)),r!==w){for(o=[],u=k();u!==w;)o.push(u),u=k();o!==w?(u=b(),u!==w?(je=e,r=ve(o),e=r):(Me=e,e=R)):(Me=e,e=R)}else Me=e,e=R;return e}function C(){var e,r,o,u;if(e=Me,84===t.charCodeAt(Me)?(r=me,Me++):(r=w,0===Ye&&n(ye)),r!==w){for(o=[],Fe.test(t.charAt(Me))?(u=t.charAt(Me),Me++):(u=w,0===Ye&&n(ge));u!==w;)o.push(u),Fe.test(t.charAt(Me))?(u=t.charAt(Me),Me++):(u=w,0===Ye&&n(ge));o!==w?(u=b(),u!==w?(je=e,r=Ae(o),e=r):(Me=e,e=R)):(Me=e,e=R)}else Me=e,e=R;return e}function x(){var e,r,o;return e=Me,Fe.test(t.charAt(Me))?(r=t.charAt(Me),Me++):(r=w,0===Ye&&n(ge)),r!==w?(Fe.test(t.charAt(Me))?(o=t.charAt(Me),Me++):(o=w,0===Ye&&n(ge)),o!==w?(je=e,r=Ce(r,o),e=r):(Me=e,e=R)):(Me=e,e=R),e}function E(){var e,r,o;return e=Me,ie.test(t.charAt(Me))?(r=t.charAt(Me),Me++):(r=w,0===Ye&&n(se)),r!==w?(ie.test(t.charAt(Me))?(o=t.charAt(Me),Me++):(o=w,0===Ye&&n(se)),o!==w?(je=e,r=xe(r,o),e=r):(Me=e,e=R)):(Me=e,e=R),e}function K(){var t,e,r;return t=Me,e=x(),e!==w?(r=E(),r!==w?(je=t,e=Ee(e,r),t=e):(Me=t,t=R)):(Me=t,t=R),t}function b(){var e,r,o;if(e=Me,13===t.charCodeAt(Me)?(r=Ke,Me++):(r=w,0===Ye&&n(be)),r===w&&(r=M),r!==w?(10===t.charCodeAt(Me)?(o=ke,Me++):(o=w,0===Ye&&n(Te)),o!==w?(r=[r,o],e=r):(Me=e,e=R)):(Me=e,e=R),e===w){for(e=Me,r=[],32===t.charCodeAt(Me)?(o=De,Me++):(o=w,0===Ye&&n(Ie));o!==w;)r.push(o),32===t.charCodeAt(Me)?(o=De,Me++):(o=w,0===Ye&&n(Ie));r!==w?(44===t.charCodeAt(Me)?(o=we,Me++):(o=w,0===Ye&&n(Be)),o!==w?(r=[r,o],e=r):(Me=e,e=R)):(Me=e,e=R)}return e}function k(){var e;return Ue.test(t.charAt(Me))?(e=t.charAt(Me),Me++):(e=w,0===Ye&&n(Re)),e}function T(t){var e,r,n=t%60;return e=(t-n)/60,r=e%60,e=(e-r)/60,{h:e,m:r,s:n}}var D,I=arguments.length>1?arguments[1]:{},w={},B={kifu:u},U=u,R=w,M=null,j=function(t,e,r){return{players:t,start:e,moves:r,type:"csa"}},P="N+",$={type:"literal",value:"N+",description:'"N+"'},N=function(t){return t},S="N-",Y={type:"literal",value:"N-",description:'"N-"'},H=function(t){return t},O=function(t,e){return[t.join(""),e.join("")]},G=function(t,e){return{board:t,teban:e}},z="PI",Z={type:"literal",value:"PI",description:'"PI"'},_="P",L={type:"literal",value:"P",description:'"P"'},W=/^[1-9]/,J={type:"class",value:"[1-9]",description:"[1-9]"},q=function(t){return t},Q=" * ",V={type:"literal",value:" * ",description:'" * "'},X=function(){return[]},te=function(t,e){return e.unshift(t),e},ee=function(t){return{comments:t}},re=function(t,e,r){return{comment:t,move:e,time:r}},ne=function(t,e,r){return{from:0==t.x?null:t,to:e,piece:r}},oe="%",ue={type:"literal",value:"%",description:'"%"'},ie=/^[A-Z]/,se={type:"class",value:"[A-Z]",description:"[A-Z]"},ae=function(t){return{special:t.join("")}},ce="+",le={type:"literal",value:"+",description:'"+"'},fe="-",pe={type:"literal",value:"-",description:'"-"'},he="'",de={type:"literal",value:"'",description:'"\'"'},ve=function(t){return t.join("")},me="T",ye={type:"literal",value:"T",description:'"T"'},Fe=/^[0-9]/,ge={type:"class",value:"[0-9]",description:"[0-9]"},Ae=function(t){return{now:T(parseInt(t.join("")))}},Ce=function(t,e){return{x:parseInt(t),y:parseInt(e)}},xe=function(t,e){return t+e},Ee=function(t,e){return{xy:t,piece:e}},Ke="\r",be={type:"literal",value:"\r",description:'"\\r"'},ke="\n",Te={type:"literal",value:"\n",description:'"\\n"'},De=" ",Ie={type:"literal",value:" ",description:'" "'},we=",",Be={type:"literal",value:",",description:'","'},Ue=/^[^\r\n]/,Re={type:"class",value:"[^\\r\\n]",description:"[^\\r\\n]"},Me=0,je=0,Pe=0,$e={line:1,column:1,seenCR:!1},Ne=0,Se=[],Ye=0;if("startRule"in I){if(!(I.startRule in B))throw new Error("Can't start parsing from rule \""+I.startRule+'".');U=B[I.startRule]}if(D=U(),D!==w&&Me===t.length)return D;throw D!==w&&Me<t.length&&n({type:"end",description:"end of input"}),o(null,Se,Ne)}return t(e,Error),{SyntaxError:e,parse:r}}()}();